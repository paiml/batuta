name: Docker Build & Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Dockerfile'
      - 'Dockerfile.dev'
      - 'docker-compose.yml'
      - '.dockerignore'
      - 'scripts/docker-build.sh'
      - '.github/workflows/docker.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # Build production Docker image
  docker-prod:
    name: Build Production Image
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build production image
      run: |
        docker build -t batuta:latest \
          --cache-from=type=local,src=/tmp/.buildx-cache \
          --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
          .

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Test production image
      run: |
        docker run --rm batuta:latest batuta --version
        docker run --rm batuta:latest batuta --help

    - name: Check image size
      run: |
        SIZE=$(docker images batuta:latest --format "{{.Size}}")
        echo "Production image size: $SIZE"
        # Warn if image > 300MB (target: 150-200MB)
        docker images batuta:latest

  # Build development Docker image
  docker-dev:
    name: Build Development Image
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build development image
      run: |
        docker build -f Dockerfile.dev -t batuta:dev .

    - name: Test development image
      run: |
        docker run --rm batuta:dev cargo --version
        docker run --rm batuta:dev rustc --version

  # Test docker-compose services
  docker-compose:
    name: Test Docker Compose
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build all services
      run: |
        docker-compose build batuta dev

    - name: Run CI service
      run: |
        docker-compose up --abort-on-container-exit ci
      timeout-minutes: 10

    - name: Check service logs
      if: always()
      run: |
        docker-compose logs

    - name: Cleanup
      if: always()
      run: |
        docker-compose down -v

  # Multi-stage build verification
  multi-stage:
    name: Verify Multi-Stage Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build with BuildKit
      run: |
        DOCKER_BUILDKIT=1 docker build \
          --target builder \
          --tag batuta:builder \
          .

    - name: Verify builder stage
      run: |
        docker run --rm batuta:builder cargo --version

    - name: Build runtime stage
      run: |
        DOCKER_BUILDKIT=1 docker build \
          --tag batuta:runtime \
          .

    - name: Verify runtime stage
      run: |
        # Runtime should be smaller than builder
        BUILDER_SIZE=$(docker images batuta:builder --format "{{.Size}}")
        RUNTIME_SIZE=$(docker images batuta:runtime --format "{{.Size}}")
        echo "Builder: $BUILDER_SIZE, Runtime: $RUNTIME_SIZE"

  # Security scan
  security-scan:
    name: Security Scan (Trivy)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build image
      run: docker build -t batuta:latest .

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'batuta:latest'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
        exit-code: '0'  # Don't fail on vulnerabilities (warn only)

    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  # Docker build script test
  build-script:
    name: Test Build Script
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Make script executable
      run: chmod +x scripts/docker-build.sh

    - name: Test production build
      run: ./scripts/docker-build.sh prod

    - name: Test development build
      run: ./scripts/docker-build.sh dev

    - name: Test CI build
      run: ./scripts/docker-build.sh ci

  # Docker success gate
  docker-success:
    name: Docker CI Success
    runs-on: ubuntu-latest
    needs: [docker-prod, docker-dev, docker-compose, multi-stage, security-scan, build-script]

    steps:
    - name: All Docker checks passed
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘  âœ… All Docker CI Checks PASSED               â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "Docker Compliance:"
        echo "âœ… Production image builds successfully"
        echo "âœ… Development image builds successfully"
        echo "âœ… Docker Compose services work"
        echo "âœ… Multi-stage build verified"
        echo "âœ… Security scan completed"
        echo "âœ… Build scripts functional"
        echo ""
        echo "Ready for deployment! ğŸ³"
